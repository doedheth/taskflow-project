# TaskFlow - Architecture Documentation

**Project Name:** TaskFlow - Task & Maintenance Management System
**Document Version:** 1.0
**Generated:** 2025-12-31
**Generated By:** BMad Master - Document Project Workflow (Exhaustive Scan)

---

## 1. Project Overview

### 1.1 Description
TaskFlow adalah sistem manajemen terintegrasi untuk pabrik thermoforming yang menggabungkan:
- **Task Management** - Manajemen tugas dengan Kanban, Sprint, Epic, dan Timeline
- **Maintenance Management** - Work Orders, Preventive Maintenance, Downtime Tracking
- **Production Management** - Jadwal Produksi, OEE, dan KPI
- **AI Integration** - Chatbot, Smart Assign, Writing Assistant

### 1.2 Project Type
- **Repository Type:** Multi-part Monorepo
- **Application Type:** Full-stack Web Application
- **Primary Language:** TypeScript

### 1.3 Project Structure
```
projectSAP/
├── task-manager-client/     # React Frontend (Port 3000)
├── task-manager-server/     # Node.js Backend (Port 5000)
├── docs/                    # Documentation
├── _bmad/                   # BMad Method resources
└── _bmad-output/            # Generated documentation
```

---

## 2. Technology Stack

### 2.1 Frontend (task-manager-client)

| Category | Technology | Version | Purpose |
|----------|------------|---------|---------|
| **Framework** | React | 18.3.1 | UI Library |
| **Build Tool** | Vite | 5.4.10 | Fast bundler |
| **Language** | TypeScript | 5.6.3 | Type safety |
| **Styling** | Tailwind CSS | 3.4.14 | Utility-first CSS |
| **Routing** | React Router DOM | 6.28.0 | SPA routing |
| **HTTP Client** | Axios | 1.7.7 | API calls |
| **Charts** | Recharts | 3.6.0 | Data visualization |
| **Drag & Drop** | @dnd-kit | 6.1.0 | Kanban board |
| **Rich Text** | React-Quill | 2.0.x | Text editing |
| **Date Utils** | date-fns | 3.6.0 | Date formatting |
| **Notifications** | react-hot-toast | 2.4.1 | Toast messages |
| **Icons** | lucide-react | 0.454.0 | Icon library |
| **Fonts** | DM Sans, JetBrains Mono | - | Typography |

### 2.2 Backend (task-manager-server)

| Category | Technology | Version | Purpose |
|----------|------------|---------|---------|
| **Runtime** | Node.js | - | Server runtime |
| **Framework** | Express | 4.21.1 | HTTP server |
| **Language** | TypeScript | 5.9.3 | Type safety |
| **Database** | SQLite (sql.js) | 1.11.0 | Embedded database |
| **Auth** | JWT (jsonwebtoken) | 9.0.2 | Authentication |
| **Password** | bcryptjs | 2.4.3 | Password hashing |
| **Validation** | express-validator | 7.2.0 | Input validation |
| **AI** | OpenAI | 6.15.0 | GPT integration |
| **File Upload** | Multer | 2.0.2 | File handling |
| **Testing** | Jest | 29.7.0 | Unit tests |
| **Linting** | ESLint + Prettier | Latest | Code quality |

---

## 3. System Architecture

### 3.1 High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         FRONTEND                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    React + Vite (Port 3000)                 ││
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││
│  │  │  Pages   │  │Components│  │ Context  │  │ Services │    ││
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││
│  └─────────────────────────────────────────────────────────────┘│
└───────────────────────────────┬─────────────────────────────────┘
                                │ HTTP /api (Vite Proxy)
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                          BACKEND                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                   Express.js (Port 5000)                    ││
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐    ││
│  │  │  Routes  │──│Controllers│──│ Services │──│   Repos  │    ││
│  │  │  (v2)    │  │          │  │          │  │          │    ││
│  │  └──────────┘  └──────────┘  └──────────┘  └──────────┘    ││
│  │       │                                          │          ││
│  │       ▼                                          ▼          ││
│  │  ┌──────────┐                            ┌──────────────┐   ││
│  │  │ Auth MW  │                            │ SQLite (sql.js)│  ││
│  │  └──────────┘                            └──────────────┘   ││
│  └─────────────────────────────────────────────────────────────┘│
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      EXTERNAL SERVICES                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                    OpenAI GPT API                         │   │
│  │         (Chatbot, Smart Assign, Writing Assistant)        │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 Backend Architecture Pattern

Backend menggunakan **OOP Layered Architecture** dengan pattern:

```
Routes (v2) → Controllers → Services → Repositories → Database
```

| Layer | Responsibility | Example Files |
|-------|----------------|---------------|
| **Routes** | HTTP endpoints, validation | `routes/v2/workOrders.ts` |
| **Controllers** | Request handling, response | `controllers/WorkOrderController.ts` |
| **Services** | Business logic | `services/WorkOrderService.ts` |
| **Repositories** | Data access | `models/WorkOrderRepository.ts` |

### 3.3 Frontend Architecture

Frontend menggunakan pattern berbasis **Context + Hooks**:

```
App
├── Providers (Theme, Auth)
│   └── Layout
│       └── Pages
│           └── Components
│               └── Services (API calls)
```

**Context Providers:**
- `AuthContext` - User authentication state
- `ThemeContext` - Light/Dark mode
- `MobileMenuContext` - Mobile navigation

---

## 4. API Architecture

### 4.1 API Versioning

| Version | Status | Path | Notes |
|---------|--------|------|-------|
| Legacy | Active | `/api/{resource}` | Routes tanpa OOP |
| V2 | Active | `/api/{resource}` | OOP refactored, same paths |

### 4.2 API Endpoints Summary

#### Authentication
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/auth/login` | User login |
| POST | `/api/auth/register` | User registration |
| GET | `/api/auth/me` | Get current user |
| PUT | `/api/auth/change-password` | Change password |

#### Tickets (Task Management)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/tickets` | List all tickets |
| GET | `/api/tickets/:id` | Get ticket by ID |
| POST | `/api/tickets` | Create ticket |
| PUT | `/api/tickets/:id` | Update ticket |
| DELETE | `/api/tickets/:id` | Delete ticket |
| PATCH | `/api/tickets/:id/status` | Update status |
| POST | `/api/tickets/:id/assignees` | Add assignee |
| DELETE | `/api/tickets/:id/assignees/:userId` | Remove assignee |
| POST | `/api/tickets/quick-maintenance` | Quick maintenance ticket + WO |

#### Work Orders (Maintenance)
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/work-orders` | List all work orders |
| GET | `/api/work-orders/:id` | Get work order by ID |
| POST | `/api/work-orders` | Create work order |
| PUT | `/api/work-orders/:id` | Update work order |
| DELETE | `/api/work-orders/:id` | Delete work order |
| POST | `/api/work-orders/:id/start` | Start work order |
| POST | `/api/work-orders/:id/complete` | Complete work order |
| POST | `/api/work-orders/:id/cancel` | Cancel work order |
| POST | `/api/work-orders/from-ticket/:ticketId` | Create WO from ticket |

#### Assets
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/assets` | List all assets |
| GET | `/api/assets/:id` | Get asset by ID |
| POST | `/api/assets` | Create asset |
| PUT | `/api/assets/:id` | Update asset |
| DELETE | `/api/assets/:id` | Delete asset |
| PATCH | `/api/assets/:id/status` | Update status |
| GET | `/api/assets/categories` | Get categories |
| GET | `/api/assets/failure-codes` | Get failure codes |

#### Downtime
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/downtime` | List all downtime logs |
| GET | `/api/downtime/active` | Get active downtime |
| POST | `/api/downtime/start` | Start downtime |
| POST | `/api/downtime/:id/end` | End downtime |
| GET | `/api/downtime/classifications` | Get classifications |
| GET | `/api/downtime/check-schedule/:assetId` | Check production schedule |

#### Reports
| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/reports/kpi/dashboard` | KPI dashboard |
| GET | `/api/reports/kpi/production` | Production KPI |
| GET | `/api/reports/kpi/asset/:assetId` | Asset KPI |
| GET | `/api/reports/maintenance-compliance` | PM compliance |
| GET | `/api/reports/technician-performance` | Technician performance |

#### AI
| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/ai/chat` | Basic chat |
| POST | `/api/ai/smart-chat` | Smart chat with tools |
| POST | `/api/ai/suggest-assignee` | AI assignee suggestion |
| POST | `/api/ai/format-text` | AI text formatting |
| POST | `/api/ai/write-assist` | Writing assistant |
| GET | `/api/ai/tools` | Get available tools |

---

## 5. Data Models

### 5.1 Core Entities

#### Users
```typescript
interface User {
  id: number;
  email: string;
  name: string;
  avatar?: string;
  whatsapp?: string;
  role: 'admin' | 'manager' | 'supervisor' | 'member';
  department_id?: number;
}
```

#### Tickets
```typescript
interface Ticket {
  id: number;
  ticket_key: string;           // e.g., "TM-1"
  title: string;
  description?: string;
  type: 'bug' | 'task' | 'story' | 'epic';
  priority: 'low' | 'medium' | 'high' | 'critical';
  status: 'todo' | 'in_progress' | 'review' | 'done';
  story_points?: number;
  reporter_id: number;
  assignees?: Assignee[];
  department_id?: number;
  epic_id?: number;
  sprint_id?: number;
  due_date?: string;
  // Integration fields
  asset_id?: number;
  related_wo_id?: number;
}
```

#### Work Orders
```typescript
interface WorkOrder {
  id: number;
  wo_number: string;            // e.g., "WO-2025-0001"
  asset_id: number;
  type: 'preventive' | 'corrective' | 'emergency';
  priority: 'low' | 'medium' | 'high' | 'critical';
  status: 'open' | 'in_progress' | 'on_hold' | 'completed' | 'cancelled';
  title: string;
  description?: string;
  failure_code_id?: number;
  maintenance_schedule_id?: number;
  assignees?: WorkOrderAssignee[];
  // Integration fields
  related_ticket_id?: number;
  sprint_id?: number;
  // Scheduling
  scheduled_start?: string;
  actual_start?: string;
  actual_end?: string;
  labor_hours?: number;
}
```

#### Assets
```typescript
interface Asset {
  id: number;
  asset_code: string;           // e.g., "TFM-001"
  name: string;
  category_id?: number;
  location?: string;
  manufacturer?: string;
  model?: string;
  serial_number?: string;
  status: 'operational' | 'maintenance' | 'breakdown' | 'retired';
  criticality: 'low' | 'medium' | 'high' | 'critical';
  department_id?: number;
}
```

#### Downtime Logs
```typescript
interface DowntimeLog {
  id: number;
  asset_id: number;
  work_order_id?: number;
  downtime_type: 'planned' | 'unplanned';
  classification_id?: number;
  start_time: string;
  end_time?: string;
  duration_minutes?: number;
  was_scheduled_production?: boolean;
  reason?: string;
  failure_code_id?: number;
}
```

### 5.2 Entity Relationships

```
┌─────────────────┐      ┌─────────────────┐
│    USERS        │──────│  DEPARTMENTS    │
└────────┬────────┘      └─────────────────┘
         │
    ┌────┴────┬────────────────┐
    │         │                │
    ▼         ▼                ▼
┌────────┐ ┌────────┐   ┌────────────┐
│TICKETS │ │ WORK   │   │MAINTENANCE │
│        │ │ORDERS  │   │ SCHEDULES  │
└────┬───┘ └───┬────┘   └─────┬──────┘
     │         │              │
     │    ┌────┴────┐         │
     │    │  ASSETS │◄────────┘
     │    └────┬────┘
     │         │
     │    ┌────┴────┐
     │    │DOWNTIME │
     │    │  LOGS   │
     │    └─────────┘
     │
┌────┴────┐
│ SPRINTS │
│  EPICS  │
└─────────┘
```

### 5.3 Database Tables Summary

| Table | Description | Key Relations |
|-------|-------------|---------------|
| `users` | User accounts | → departments |
| `departments` | Team departments | - |
| `tickets` | Tasks/bugs/stories | → users, departments, sprints, epics |
| `ticket_assignees` | Many-to-many assignees | → tickets, users |
| `sprints` | Agile sprints | - |
| `comments` | Ticket comments | → tickets, users |
| `attachments` | File attachments | → tickets, users |
| `notifications` | User notifications | → users, tickets |
| `assets` | Equipment/machines | → asset_categories, departments |
| `asset_categories` | Asset groupings | - |
| `work_orders` | Maintenance work orders | → assets, users, tickets |
| `work_order_assignees` | WO assignees | → work_orders, users |
| `downtime_logs` | Downtime records | → assets, work_orders |
| `downtime_classifications` | Downtime categories | - |
| `failure_codes` | Failure categorization | - |
| `maintenance_schedules` | PM schedules | → assets, users |
| `production_schedule` | Production calendar | → assets, shift_patterns |
| `shift_patterns` | Work shifts | - |
| `chat_conversations` | AI chat history | → users |
| `chat_messages` | Chat messages | → chat_conversations |

---

## 6. Authentication & Authorization

### 6.1 Authentication Flow

1. User submits credentials to `/api/auth/login`
2. Server validates credentials with bcrypt
3. Server generates JWT token (expires in 7 days)
4. Client stores token in localStorage
5. Client sends token in `Authorization: Bearer <token>` header
6. Server validates token via `auth` middleware

### 6.2 Role-Based Access Control

| Role | Level | Permissions |
|------|-------|-------------|
| **admin** | Highest | Full access to all features |
| **manager** | High | Create/edit work orders, manage users, view reports |
| **supervisor** | Medium | Manage team, approve work, view reports |
| **member** | Basic | View and work on assigned tasks |

### 6.3 Middleware

```typescript
// auth - Validates JWT token
// managerOrAdmin - Requires manager or admin role
```

---

## 7. Frontend Pages & Components

### 7.1 Page Routes

#### Task Management
| Route | Page | Description |
|-------|------|-------------|
| `/` | Dashboard | Main dashboard with stats |
| `/tickets` | Tickets | Task list view |
| `/tickets/:id` | TicketDetail | Task detail page |
| `/board` | KanbanBoard | Kanban view |
| `/epics` | Epics | Epic management |
| `/epics/:id` | EpicDetail | Epic detail |
| `/sprints` | Sprints | Sprint management |
| `/sprints/:id` | SprintBoard | Sprint board |
| `/timeline` | Timeline | Gantt chart view |

#### Maintenance
| Route | Page | Description |
|-------|------|-------------|
| `/assets` | Assets | Asset list |
| `/assets/:id` | AssetDetail | Asset detail |
| `/work-orders` | WorkOrders | Work order list |
| `/work-orders/:id` | WorkOrderDetail | WO detail |
| `/downtime-tracker` | DowntimeTracker | Downtime monitoring |
| `/maintenance-calendar` | MaintenanceCalendar | PM calendar |
| `/maintenance-kpi` | MaintenanceKPI | Maintenance metrics |

#### Production
| Route | Page | Description |
|-------|------|-------------|
| `/production-schedule` | ProductionSchedule | Production calendar |
| `/production-downtime` | ProductionDowntime | Quick downtime logging |
| `/production-kpi` | ProductionKPI | OEE and production metrics |

#### Settings
| Route | Page | Description |
|-------|------|-------------|
| `/users` | Users | User management |
| `/departments` | Departments | Department setup |
| `/shift-settings` | ShiftSettings | Shift configuration |
| `/failure-codes` | FailureCodes | Failure code setup |
| `/downtime-classifications` | DowntimeClassifications | Classification setup |

### 7.2 Key Components

| Component | Purpose |
|-----------|---------|
| `Layout` | Main layout with sidebar |
| `Sidebar` | Navigation sidebar |
| `Header` | Top header with theme toggle |
| `CreateTicketModal` | Create new ticket |
| `RichTextEditor` | Quill-based editor |
| `ChatBot` | AI assistant chatbot |
| `AIWritingAssistant` | AI text enhancement |
| `AISuggestionPanel` | Context suggestions |
| `AssigneeMultiSelect` | Multi-user selector |
| `ThemeToggle` | Dark/Light mode toggle |

---

## 8. Theme System

### 8.1 Color Palette

#### Dark Mode
| Color | Usage |
|-------|-------|
| `bg-dark-950` | Page background |
| `bg-dark-900` | Secondary background |
| `bg-dark-800` | Card background |
| `bg-dark-700` | Input background |
| `bg-dark-600` | Borders |
| `text-white` | Primary text |
| `text-dark-300` | Secondary text |
| `text-dark-400` | Muted text |

#### Light Mode
| Color | Usage |
|-------|-------|
| `bg-gray-50` | Page background |
| `bg-white` | Card background |
| `bg-gray-100` | Secondary background |
| `text-gray-900` | Primary text |
| `text-gray-600` | Secondary text |
| `text-gray-500` | Muted text |

### 8.2 Status Colors

| Status | Purpose | Color Pattern |
|--------|---------|---------------|
| todo | Pending tasks | Gray |
| open | Open items | Blue |
| in_progress | Active work | Yellow |
| review | Under review | Purple |
| done/completed | Finished | Green |
| critical | High priority | Red |

---

## 9. AI Integration

### 9.1 AI Features

| Feature | Description | Endpoint |
|---------|-------------|----------|
| **Chatbot** | Conversational AI assistant | `/api/ai/smart-chat` |
| **Smart Assign** | AI-suggested assignees | `/api/ai/suggest-assignee` |
| **Writing Assistant** | Text enhancement | `/api/ai/write-assist` |
| **Text Formatting** | Format descriptions | `/api/ai/format-text` |
| **Autocomplete** | Title suggestions | `/api/ai/autocomplete` |
| **Ticket Analysis** | Analyze ticket content | `/api/ai/analyze-ticket` |

### 9.2 AI Tools (Function Calling)

The smart chat supports tool/function calling for:
- Getting ticket information
- Creating tickets
- Updating work orders
- Getting KPI metrics
- Searching assets
- And more...

---

## 10. Integration Points

### 10.1 Ticket ↔ Work Order Integration

Tickets and Work Orders can be linked:
- Create WO from Ticket: `POST /api/work-orders/from-ticket/:ticketId`
- View linked WOs: `GET /api/work-orders/by-ticket/:ticketId`
- Quick Maintenance: Creates both ticket and WO simultaneously

### 10.2 PM ↔ Downtime Integration

When a PM Work Order is started/completed:
- Auto-create downtime log when WO starts (if PM-PROD classification)
- Auto-end downtime log when WO completes
- Auto-update `next_due` in maintenance schedule

### 10.3 Production Schedule Integration

Downtime can check production schedule to determine:
- If asset is in production (counts as downtime)
- If in maintenance window (doesn't count)
- If no order / holiday (doesn't count)

---

## 11. Development Guidelines

### 11.1 Code Conventions

| Context | Language/Style |
|---------|----------------|
| UI Labels | Indonesian |
| Code Comments | English |
| Variable Names | English (camelCase) |
| Error Messages (API) | English |
| Console Logs | English |
| Database Tables | snake_case (plural) |
| Database Columns | snake_case |
| React Components | PascalCase |
| TypeScript Interfaces | PascalCase |

### 11.2 Running the Project

```bash
# From root directory
npm run dev           # Run both server (5000) and client (3000)
npm run server        # Run server only
npm run client        # Run client only

# From task-manager-server/
npm run dev           # Run server only
npm run dev:all       # Run both server and client
```

### 11.3 Default Credentials

```
Admin:
  Email: admin@taskmanager.com
  Password: admin123

Sample User:
  Email: john@taskmanager.com
  Password: password123
```

---

## 12. Key Metrics & KPIs

### 12.1 Maintenance KPIs

| Metric | Description | Calculation |
|--------|-------------|-------------|
| **Availability** | % time asset available | (Scheduled - Downtime) / Scheduled × 100 |
| **MTBF** | Mean Time Between Failures | Operating Hours / Failure Count |
| **MTTR** | Mean Time To Repair | Total Repair Time / Failure Count |
| **PM Compliance** | % PM completed on time | On-time PM / Total Scheduled × 100 |

### 12.2 Production KPIs

| Metric | Description |
|--------|-------------|
| **OEE** | Overall Equipment Effectiveness |
| **Availability** | Actual runtime vs scheduled |
| **Performance** | Actual vs target production |
| **Quality** | Good units vs total produced |

---

## 13. Known Patterns & Decisions

### 13.1 Architecture Decisions

1. **SQLite (sql.js)** - Chosen for simplicity and portability (no external DB server needed)
2. **JWT Auth** - Stateless authentication with 7-day expiry
3. **Layered Backend** - Controller → Service → Repository for separation of concerns
4. **Context API** - Used for global state (Auth, Theme) instead of Redux
5. **Tailwind CSS** - Utility-first approach for rapid UI development
6. **Vite Proxy** - Proxies `/api` to backend during development

### 13.2 Data Patterns

1. **Soft Delete** - Not implemented; records are hard deleted
2. **Timestamps** - All entities have `created_at` and `updated_at`
3. **Counters** - Ticket keys and WO numbers use counter tables
4. **JSON Fields** - Some fields store JSON as strings (checklist, production_impact)

---

## Document Metadata

- **Scan Level:** Exhaustive
- **Files Analyzed:** 65+ TypeScript files
- **Lines of Code:** ~15,000+ LOC
- **Generated By:** BMad Master Document Project Workflow
